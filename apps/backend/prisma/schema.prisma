// Prisma Schema for Visio E-Commerce Backend
// Production-ready schema with multi-layer architecture support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id               String              @id @default(cuid())
  email            String              @unique
  username         String              @unique
  passwordHash     String?
  role             UserRole            @default(USER)
  creditBalance    Decimal             @default(500.0) @db.Decimal(10, 2)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  deletedAt        DateTime?

  lastLoginAt      DateTime?
  failedLoginCount Int                 @default(0)
  isLocked         Boolean             @default(false)

  // Relations
  authProviders    UserAuthProvider[]
  addresses        UserAddress[]
  carts            Cart[]
  orders           Order[]
  reviews          Review[]
  wishlistItems    WishlistItem[]
  creditTxns       CreditTransaction[]
}

enum UserRole {
  USER
  ADMIN
}

model UserAuthProvider {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  provider   String
  providerId String
  createdAt  DateTime @default(now())

  @@unique([provider, providerId])
  @@index([userId])
}

model UserAddress {
  id         String    @id @default(cuid())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  label      String?
  fullName   String
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String?
  country    String
  phone      String?
  isDefault  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  shippingOrders Order[] @relation("ShippingAddress")
  billingOrders  Order[] @relation("BillingAddress")

  @@index([userId])
}

// ============================================
// CATEGORY & PRODUCT MODELS
// ============================================

model Category {
  id          String            @id @default(cuid())
  slug        String            @unique
  name        String
  description String?
  parentId    String?
  parent      Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[]        @relation("CategoryHierarchy")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?

  products    ProductCategory[]

  @@index([parentId])
  @@index([slug])
}

model Product {
  id                String              @id @default(cuid())
  name              String
  slug              String              @unique
  description       String
  price             Decimal             @db.Decimal(10, 2)
  stock             Int
  salePercent       Int?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  deletedAt         DateTime?

  mainImageUrl      String?
  mainImagePublicId String?

  images            ProductImage[]
  categories        ProductCategory[]
  reviews           Review[]
  orderItems        OrderItem[]
  cartItems         CartItem[]
  wishlistItems     WishlistItem[]
  stockSubscriptions BackInStockSubscription[]

  @@index([slug])
  @@index([isActive])
  @@index([salePercent])
}

model ProductImage {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  url       String
  publicId  String
  width     Int?
  height    Int?
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId])
}

model ProductCategory {
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String

  @@id([productId, categoryId])
  @@index([categoryId])
}

// ============================================
// CART MODELS
// ============================================

model Cart {
  id        String     @id @default(cuid())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId])
}

model CartItem {
  id        String   @id @default(cuid())
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  quantity  Int      @default(1)
  unitPrice Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
}

// ============================================
// ORDER & PAYMENT MODELS
// ============================================

model Order {
  id                String       @id @default(cuid())
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  status            OrderStatus  @default(PENDING)
  totalAmount       Decimal      @db.Decimal(10, 2)
  currency          String       @default("USD")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  shippingAddress   UserAddress? @relation("ShippingAddress", fields: [shippingAddressId], references: [id], onDelete: SetNull)
  shippingAddressId String?
  billingAddress    UserAddress? @relation("BillingAddress", fields: [billingAddressId], references: [id], onDelete: SetNull)
  billingAddressId  String?

  items             OrderItem[]
  payment           Payment?

  @@index([userId])
  @@index([status])
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  SHIPPED
  COMPLETED
}

model OrderItem {
  id          String  @id @default(cuid())
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     String
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  salePercent Int?

  @@index([orderId])
}

model Payment {
  id            String        @id @default(cuid())
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       String        @unique
  status        PaymentStatus @default(PENDING)
  provider      String?
  transactionId String?       @unique
  amount        Decimal       @db.Decimal(10, 2)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================
// REVIEW & WISHLIST MODELS
// ============================================

model Review {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  rating    Int
  title     String?
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId])
}

model WishlistItem {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
}

// ============================================
// CREDIT & SUBSCRIPTION MODELS
// ============================================

model CreditTransaction {
  id          String        @id @default(cuid())
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  amount      Decimal       @db.Decimal(10, 2)
  type        CreditTxnType
  referenceId String?
  note        String?
  createdAt   DateTime      @default(now())

  @@index([userId])
}

enum CreditTxnType {
  INITIAL_BONUS
  PURCHASE_DEBIT
  REFUND_CREDIT
  ADMIN_ADJUST
}

model BackInStockSubscription {
  id         String    @id @default(cuid())
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String
  email      String
  createdAt  DateTime  @default(now())
  notifiedAt DateTime?

  @@unique([productId, email])
  @@index([productId])
}
